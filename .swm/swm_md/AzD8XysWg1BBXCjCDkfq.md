<div align="center" style="background-color: #e5ecff; color: black"><br/><div>DOC</div><h1>Add a new configuration setting to the Agent âš™</h1><br/></div>
<br/>

### Files Used
ðŸ“„ monkey/infection_monkey/config.py

ðŸ“„ monkey/infection_monkey/monkey.py

ðŸ“„ monkey/monkey_island/cc/services/config_schema/internal.py


<br/>

# Make something configurable

In this unit, you will learn how to add a configuration option to Monkey and how to use it in the Monkey Agent code. 

## Why is this important?

Enabling users to configure the Monkey's behaviour gives them a lot more freedom in how they want to use the Monkey and enables more use cases.

## What is "Max victims to find"?

The Monkey has a function which finds "victim" machines on the network for the Monkey to try and exploit. It's called `get_victim_machines`. This function accepts an argument which limits how many machines the Monkey should find.

We want to make that value editable by the user instead of constant in the code.

## Manual testing

1. After you've performed the required changes, reload the Server and check your value exists in the Internal tab of the config (see image).

2. Set the new value to 1, and run Monkey locally (from source). See that the Monkey only scans one machine.

<br/>

In this step we define the value

<div style="background: #e5ecff; padding: 10px 10px 10px 10px; border-bottom: 1px solid #c1c7d0; border-radius: 4px; color: black">    ðŸ“„ monkey/infection_monkey/config.py âœ… Up to Date*

   </div>

```python
â¬œ 131        exploiter_classes = []
â¬œ 132        system_info_collector_classes = []
â¬œ 133    
ðŸŸ© 134        # how many victims to look for in a single scan iteration
ðŸŸ© 135        victims_max_find = 100
ðŸŸ© 136    
â¬œ 137        # how many victims to exploit before stopping
â¬œ 138        victims_max_exploit = 100
â¬œ 139    
```
<br/>

In this step we use the configuration value

<div style="background: #e5ecff; padding: 10px 10px 10px 10px; border-bottom: 1px solid #c1c7d0; border-radius: 4px; color: black">    ðŸ“„ monkey/infection_monkey/monkey.py âœ… Up to Date*

   </div>

```python
â¬œ 159                    if not self._keep_running or not WormConfiguration.alive:
â¬œ 160                        break
â¬œ 161    
ðŸŸ© 162                    machines = self._network.get_victim_machines(max_find=WormConfiguration.victims_max_find,
ðŸŸ© 163                                                                 stop_callback=ControlClient.check_for_stop)
â¬œ 164                    is_empty = True
â¬œ 165                    for machine in machines:
â¬œ 166                        if ControlClient.check_for_stop():
```
<br/>

Note that we have to **explicitly** state all the fields of the schema in `monkey/monkey_island/cc/services/config_schema/internal.py âœ“`, where all fields for every configuration value are declared.

Note that we set the default value to `100 âœ“` , and this value appears on the UI, next to the given `title âœ“` .

<div style="background: #e5ecff; padding: 10px 10px 10px 10px; border-bottom: 1px solid #c1c7d0; border-radius: 4px; color: black">    ðŸ“„ monkey/monkey_island/cc/services/config_schema/internal.py âœ… Up to Date*

   </div>

```python
â¬œ 40                 "title": "Monkey",
â¬œ 41                 "type": "object",
â¬œ 42                 "properties": {
ðŸŸ© 43                     "victims_max_find": {
ðŸŸ© 44                         "title": "Max victims to find",
ðŸŸ© 45                         "type": "integer",
ðŸŸ© 46                         "default": 100,
ðŸŸ© 47                         "description": "Determines the maximum number of machines the monkey is allowed to scan"
ðŸŸ© 48                     },
â¬œ 49                     "victims_max_exploit": {
â¬œ 50                         "title": "Max victims to exploit",
â¬œ 51                         "type": "integer",
```
<br/>

* When changing config schema by adding or deleting keys, you need to update the Blackbox Test configurations as well [here](https://github.com/guardicore/monkey/tree/develop/envs/monkey_zoo/blackbox/island_configs).

<br/>

<br/><br/>

This file was generated by Swimm. [Click here to view it in the app](https://swimm.io/link?l=c3dpbW0lM0ElMkYlMkZyZXBvcyUyRlpnMWZscldSZ3ZsczBjMm1GeURJJTJGZG9jcyUyRkF6RDhYeXNXZzFCQlhDakNEa2Zx). Timestamp: 2021-06-23T14:09:32.442Z (UTC)
